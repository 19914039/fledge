#!/bin/bash
##############################################################################
#
# FogLAMP Test template
# Copyright (C) 2018 Dianomic Systems, Inc.
#
##############################################################################


##############################################################################
#
## This is a template to run create system tests
#
##############################################################################

set -e

debug_mode=""
test_to_run="0"
print_help=false

FOGLAMP_TEST_BASEDIR=`realpath ..`
FOGLAMP_BASEDIR=`realpath ../../..`

MESSAGE="# This test file will be automatically generated by the test script."

cd "${FOGLAMP_TEST_BASEDIR}/suite"


##  Print the help screen
do_help() {

	echo
	echo "foglamp-test-template : Execute the FogLAMP Template Test Suite"
  echo
  echo "Parameters:"
  echo " -t | --test <test-number>  Execute test number <test-number>"
	echo " -h | --help                Print this help"
	echo " -d | --debug               The script is executed with set +x"
	echo
  echo "Tests:"
  echo
	exit 0

}


## Test 001: Create Table
do_001_create_table () {

  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance \
      --do-test=001_create_table

}


## Test 002: First Insert
do_002_first_insert () {

  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance \
      --do-test=002_first_insert

}


## Test 003: Single Inserts
do_003_single_inserts () {

  ${SCALEDB_TEST_BASEDIR}/tests/performance_import/003_single_inserts.py   ${TEST_003_FILE_NAME}

  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance \
      --do-test=003_single_inserts

  # Cleaning the auto-generated file for test #3
  echo ${MESSAGE} > ${TEST_003_FILE_NAME}


}


## Test 004: Multiple Inserts 
do_004_multiple_inserts () {

  ${SCALEDB_TEST_BASEDIR}/tests/performance_import/004_multiple_inserts.py ${TEST_004_FILE_NAME}

  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance \
      --do-test=004_multiple_inserts   \
      --repeat=1000

  # Cleaning the auto-generated file for test #4
  echo ${MESSAGE} > ${TEST_004_FILE_NAME}

}


## Test 005: Flush Table
do_005_flush_table () {

  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance \
      --do-test=005_flush_table

}


## Test 006: Truncate Table
do_006_truncate_table () {

  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance \
      --do-test=006_truncate_table

}


## Execute the test
do_all_tests () {

  # Generate .test files
  ${SCALEDB_TEST_BASEDIR}/tests/performance_import/003_single_inserts.py   ${TEST_003_FILE_NAME}

  # Test - Full suite
  cd ${MYSQL_TEST_FRAMEWORK_BASEDIR}
  ./mysql-test-run ${MYSQL_CONNECTION} \
      --vardir=${SCALEDB_TEST_VAR}  \
      --suite=${SCALEDB_TEST_BASEDIR}/suite/performance

  # Cleaning the auto-generated file for test #3
  echo ${MESSAGE} > ${TEST_003_FILE_NAME}

  do_004_multiple_inserts
  do_005_flush_table
  do_006_truncate_table

}


### Parameter Check ###
while [ "$1" != "" ]; do
  case "$1" in
    -d | --debug )
      set -x
			debug_mode="debug"
      ;;
    -t | --test )
      shift
      test_to_run=$1
      ;;
    -h | --help )
      print_help=true
      ;;
    * )
      echo "Usage: scaledb-test-performance --help"
      exit 1
      ;;
  esac
  shift
done

### Main Logic ###
if [ "${print_help}" = true ]; then
  do_help
else
  case "$test_to_run" in
    0 )
      do_all_tests
      ;;
    1 ) 
      do_001_create_table
      ;;
    2 )
      do_002_first_insert
      ;;
    3 )
      do_003_single_inserts
      ;;
    4 )
      do_004_multiple_inserts
      ;;
    5 )
      do_005_flush_table
      ;;
    6 )
      do_006_truncate_table
      ;;
    * )
      echo "Usage: scaledb-test-performance --help"
      exit 1
      ;;
  esac
fi

exit 0

