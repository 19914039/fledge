#!/bin/bash

##--------------------------------------------------------------------
## Fledge "management" - script to check/recovery fledge
##
## Copyright (c) 2021 Dianomic Systems
##
## Released under the Apache 2.0 Licence
##
## Author: Stefano Simonelli
##
##--------------------------------------------------------------------

set -e
#set -x

#
# FLEDGE_ROOT evaluation
#
if [ "${FLEDGE_ROOT}" = "" ]; then
	FLEDGE_ROOT=/usr/local/fledge
fi

if [ ! -d "${FLEDGE_ROOT}" ]; then
	logger "Fledge home directory missing or incorrectly set environment"
	exit 1
fi

#
# fledge command evaluation
#
FLEDGE_SCRIPT="${FLEDGE_ROOT}/scripts/fledge"
if [ ! -x "${FLEDGE_SCRIPT}" ]; then

    FLEDGE_SCRIPT="${FLEDGE_ROOT}/bin/fledge"
    if [ ! -x "${FLEDGE_SCRIPT}" ]; then

	    logger "Fledge command unavailable both in deployment and development environments"
	    exit 1
    else
        FLEDGE_ENV="deployment"
    fi
else
    FLEDGE_ENV="development"
fi


#// FIXME_I: identify the newer one for the recover command
#
# sqlite3 command selection - identify the newer one for the availability of th recover command
#
SQLITE_SQL="${HOME}/bin/sqlite3"
if ! [[ -x "${SQLITE_SQL}" ]]; then

    SQLITE_SQL="$FLEDGE_ROOT/plugins/storage/sqlite/sqlite3"
    if ! [[ -x "${SQLITE_SQL}" ]]; then

        # Check system default SQLite 3 command line is available
        if ! [[ -x "$(command -v sqlite3)" ]]; then
            sqlite_log "info" "The sqlite3 command cannot be found. Is SQLite3 installed?" "outonly" "pretty"
            sqlite_log "info" "If SQLite3 is installed, check if the bin dir is in the PATH." "outonly" "pretty"
            exit 1
        else
            SQLITE_SQL="$(command -v sqlite3)"
        fi
    fi
fi

#
# Configurations
#
FLEDGE_MNT_VERSION=1.0
FLEDGE_DB="${FLEDGE_ROOT}/data/fledge.db"

#
# Functions
#
fledge_stop() {

    seconds=5
    ${FLEDGE_SCRIPT} stop

    #  // FIXME_I:
    #echo "sleeping ${seconds} seconds before fledge kill, to ensure everything is not running"
    #sleep ${seconds}
    ${FLEDGE_SCRIPT} kill
}

operation_start() {

    operation="${1}"

    echo ""
    echo "${operation}"
    echo "Operation started : $(date)"

}

fledge_check() {

    operation_start "Executing database check"
    fledge_stop

    echo -n "Checking database consistency : "
    time "${SQLITE_SQL}" "${FLEDGE_DB}" "pragma integrity_check;"
}



fledge_info_table() {
    fledge_table=$1
    count=$2

    echo "Information on the table : ${fledge_table}"

    echo -en "\tMIN Id : "
    "${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT min(id) FROM ${fledge_table} "

    echo -en "\tMAX Id : "
    "${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT max(id) FROM ${fledge_table} "

    if [[ "${count}" == "count" ]]; then

        echo -en "\tCOUNT  : "
        "${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT count(id) FROM ${fledge_table} "
    fi

    echo ""
}

fledge_info() {

    operation_start "Information on the database"

    echo "Tables:"
    "${SQLITE_SQL}" "${FLEDGE_DB}" ".tables"
    echo ""

    fledge_info_table "STATISTICS_HISTORY"
    fledge_info_table "TASKS"              "count"
    fledge_info_table "LOG"                "count"

}

#
# Comment code for debug
#
fledge_shrink_table_shrink() {
    fledge_table=$1

    echo "shrinking table ${fledge_table}"

    #// FIXME_I:
    #"${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT * FROM ${fledge_table} LIMIT 10"
    #"${SQLITE_SQL}" "${FLEDGE_DB}" "UPDATE ${fledge_table} SET history_ts = date('now','-10 day') WHERE id <= 10"
    #"${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT COUNT(*) FROM ${fledge_table} "
    "${SQLITE_SQL}" "${FLEDGE_DB}" "DELETE FROM STATISTICS_HISTORY WHERE  history_ts <= date('now','-3 day')"
    #"${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT COUNT(*) FROM ${fledge_table} "

    echo -n "Table ${fledge_table} - number of records : "
    "${SQLITE_SQL}" "${FLEDGE_DB}" "SELECT COUNT(*) FROM ${fledge_table}"

}

fledge_shrink() {

    operation_start "Executing database shrink"

    fledge_stop

    echo -n "Checking database consistency : "
    "${SQLITE_SQL}" "${FLEDGE_DB}" "pragma integrity_check;"

    if [[ "${SHRINK_MODE}" == "table" ]]; then

        fledge_shrink_table_shrink "STATISTICS_HISTORY"
    fi

    echo -n "Shrinking database"
    "${SQLITE_SQL}" "${FLEDGE_DB}" "VACUUM"
    echo ""

    echo -n "Checking database consistency : "
    "${SQLITE_SQL}" "${FLEDGE_DB}" "pragma integrity_check;"
}

export_file_check() {

    file_export=$1

    if [[ -f "${file_export}" ]]; then

        echo ""
        echo "WARNING: the export file ${file_export} is already present "
        echo ""
        echo -n "Enter YES if you want to import this one without executing the export : "
        read user_answer

        if [[ "$user_answer" != 'YES' ]]; then

            export_execute="yes"
        fi
    else
        export_execute="yes"
    fi
}

fledge_recover_sqlite3() {

    export_execute=""
    export_sql="${FLEDGE_DB}_sql"
    new_db="${FLEDGE_DB}_rec"

    operation_start "Executing SQLITE3 database recovery"
    fledge_stop

    time_start=$(date +%s)

    ###   #########################################################################################:
    export_execute=""
    file_export="${export_sql}"
    export_file_check "${file_export}"

    if [[ "$export_execute" == "yes" ]]; then

        echo -n "exporting database to a sql file : ${file_export}"
        "${SQLITE_SQL}" "${FLEDGE_DB}" ".recover" > "${file_export}"
        echo ""
    fi
    ###   #########################################################################################:

    if [[ -f "${new_db}" ]]; then

        echo ""
        echo "WARNING: the database ${new_db} is already present, deleting it "
        echo ""

        rm ${new_db}
    fi

    echo -n "Creating the new database :${new_db}:"
    ${SQLITE_SQL} "${new_db}" < "${export_sql}"
    echo ""

    time_end=$(date +%s)
    echo "Operation completed : $(date)"
    echo "Elapsed :$(($time_end - $time_start)): seconds"
}

fledge_recover_custom() {

    export_sql_schema="${FLEDGE_DB}_sql_schema"
    export_sql_data="${FLEDGE_DB}_sql_data"
    new_db="${FLEDGE_DB}_rec_custom"

    operation_start "Executing CUSTOM database recovery"
    fledge_stop

    time_start=$(date +%s)


    ###   #########################################################################################:
    export_execute=""
    file_export="${export_sql_schema}"
    export_file_check "${file_export}"

    if [[ "$export_execute" == "yes" ]]; then

        echo -n "exporting database to a sql file ${file_export}"
        "${SQLITE_SQL}" "${FLEDGE_DB}" << EOF

.output ${file_export}
.schema STATISTICS_HISTORY

EOF

        echo ""
    fi

    ###   #########################################################################################:
    export_execute=""
    file_export="${export_sql_data}"
    export_file_check "${file_export}"

    if [[ "$export_execute" == "yes" ]]; then

        echo -n "exporting database to a sql file ${file_export}"
        "${SQLITE_SQL}" "${FLEDGE_DB}" <<  EOF

.output ${file_export}

.dump TASKS
.dump SQLITE_SCHEMA
.dump LOG
.dump CONFIGURATION
.dump ASSET_LINKS
.dump ASSETS
.dump ROLE_ASSET_PERMISSIONS
.dump ROLE_RESOURCE_PERMISSION
.dump USER_ASSET_PERMISSIONS
.dump USER_RESOURCE_PERMISSIONS
.dump ASSET_MESSAGES
.dump ASSET_STATUS_CHANGES
.dump ASSET_TRACKER
.dump USERS
.dump CATEGORY_CHILDREN
.dump CONFIGURATION_CHANGES
.dump FILTERS
.dump LINKS
.dump LOG_CODES
.dump OMF_CREATED_OBJECTS
.dump PACKAGES
.dump PLUGIN_DATA
.dump RESOURCES
.dump ROLES
.dump SCHEDULED_PROCESSES
.dump SCHEDULES
.dump STATISTICS
.dump USER_LOGINS
.dump USER_PWD_HISTORY
.dump ASSET_MESSAGE_STATUS
.dump ASSET_STATUS
.dump ASSET_TYPES
.dump BACKUPS
.dump FILTER_USERS
.dump SQLITE_SEQUENCE
.dump STREAMS
.dump VERSION
EOF

        echo ""
    fi



    ###   #########################################################################################:
    if [[ -f "${new_db}" ]]; then

        echo ""
        echo "WARNING: the database ${new_db} is already present, deleting it "
        echo ""

        rm ${new_db}
    fi

    echo -n "Creating the new database :${new_db}:"
    ${SQLITE_SQL} "${new_db}" < "${export_sql_schema}"
    ${SQLITE_SQL} "${new_db}" < "${export_sql_data}"
    echo ""

    echo -n "Checking database consistency :${new_db}: -  "
    "${SQLITE_SQL}" "${new_db}" "pragma integrity_check;"

    time_end=$(date +%s)
    echo "Operation completed : $(date)"
    echo "Elapsed :$(($time_end - $time_start)): seconds"
}


fledge_recover() {

    if [[ "${RECOVER_MODE}" == "custom" ]]; then

        fledge_recover_custom
    else
        fledge_recover_sqlite3
    fi
}


fledge_help() {

    echo ""
    echo "${USAGE}
The script is used to check/recovery fledge
Arguments:
 info              - show information on the database/tables
 check             - check the fledge database, stops Fledge
 shrink            - shrink the database, stops Fledge
 shrink  --table   - delete the content of the statistics_history > 3 days and shrink the database
 recover           - attempt to recover the fledge database using the SQLITE .recover command
                   - it creates the database fledge.db_rec
 recover --custom  - a custom attempt to recover the fledge database, useful if the SQLITE .recover command fails
                   - it creates the database fledge.db_rec_custom
                   - the new database will contain an empty STATISTICS_HISTORY and all other tables
 help              - This text"
}


#
# Main code
#

echo ""
echo "Fledge management tool v${FLEDGE_MNT_VERSION}"
echo "Environment     : ${FLEDGE_ENV}"
echo "Database        : ${FLEDGE_DB}"
echo "sqlite3 command : ${SQLITE_SQL}"
echo "sqlite3 version : $(${SQLITE_SQL} --version)"


USAGE="Usage: `basename ${0}` {info|check|shrink --table|recover --custom}"

RECOVER_MODE=''
SHRINK_MODE=''

# Handle commands
case "$1" in
    info)
        fledge_info
        ;;
    check)
        fledge_check
        ;;
    shrink)
        if [ ! -z "$2" ]; then
            if [[ "$2" == "--table" ]]; then

                SHRINK_MODE='table'

                echo ""
                echo "WARNING: This operation will remove the rows older then 3 days in the table STATISTICS_HISTORY"
                echo "'${FLEDGE_DB}'"
                echo -n "Enter YES if you want to continue: "
                read continue_reset

                if [ "$continue_reset" != 'YES' ]; then

                    echo "Operation aborted."
                    # This is ok because it means that the script is called from command line
                    exit 0
                fi
            else
               echo "An invalid option has been entered: $2. Use --table"
               exit 1
            fi
        fi
        fledge_shrink
        ;;
    recover)
        if [ ! -z "$2" ]; then
            if [[ "${2}" == "--custom" ]]; then
                RECOVER_MODE='custom'
            else
               echo "An invalid option has been entered: $2. Use --custom"
               exit 1
            fi
        fi
        fledge_recover
        ;;

    help)
        fledge_help
        ;;
    *)
        echo "${USAGE}"
        exit 1
esac

exit $?
